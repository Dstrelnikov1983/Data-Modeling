// ============================================================
// Скрипт 03: CRUD-операции
// Предприятие «Руда+» — MES-система
// Среда: Yandex StoreDoc (MongoDB-совместимая СУБД)
// IDE: JetBrains DataGrip
// ============================================================
// Выполняйте запросы по одному (выделите запрос → Ctrl+Enter)
// ============================================================


// ╔════════════════════════════════════════════════════════════╗
// ║  ЧАСТЬ 1: ЧТЕНИЕ (find)                                  ║
// ╚════════════════════════════════════════════════════════════╝

// --- 1.1. Все документы в коллекции ---
db.equipment.find();

// --- 1.2. Фильтрация по полю ---
// Все ПДМ (погрузочно-доставочные машины)
db.equipment.find({ type: "ПДМ" });

// --- 1.3. Фильтрация по вложенному полю (dot notation) ---
// Оборудование шахты "Северная"
db.equipment.find({ "mine.name": "Северная" });

// --- 1.4. Комбинированный фильтр ---
// ПДМ на шахте "Северная"
db.equipment.find({
  type: "ПДМ",
  "mine.name": "Северная"
});

// --- 1.5. Операторы сравнения ---
// Оборудование с наработкой > 10 000 моточасов
db.equipment.find({
  engine_hours: { $gt: 10000 }
}).sort({ engine_hours: -1 });

// --- 1.6. Диапазон значений ---
// Наработка от 5 000 до 15 000 моточасов
db.equipment.find({
  engine_hours: { $gte: 5000, $lte: 15000 }
});

// --- 1.7. Оператор $in ---
// Оборудование в статусе "working" или "idle"
db.equipment.find({
  status: { $in: ["working", "idle"] }
});

// --- 1.8. Проекция (выбор полей) ---
// Только ID, модель и статус работающего оборудования
db.equipment.find(
  { status: "working" },
  { _id: 1, model: 1, type: 1, status: 1, engine_hours: 1 }
);

// --- 1.9. Сортировка и лимит ---
// Топ-3 по наработке
db.equipment.find(
  {},
  { _id: 1, model: 1, engine_hours: 1 }
).sort({ engine_hours: -1 }).limit(3);

// --- 1.10. Поиск по массиву ---
// Оборудование, у которого есть датчик видео
db.equipment.find({
  "sensors.type": "video"
});

// --- 1.11. Подсчёт документов ---
// Количество работающего оборудования
db.equipment.countDocuments({ status: "working" });

// --- 1.12. findOne — один документ ---
db.equipment.findOne({ _id: "EQ001" });


// ╔════════════════════════════════════════════════════════════╗
// ║  ЗАДАНИЕ 1 (самостоятельно):                              ║
// ║  Найдите все самосвалы с наработкой от 5 000 до 15 000    ║
// ║  моточасов. Выведите _id, model, engine_hours.            ║
// ╚════════════════════════════════════════════════════════════╝

// Ваш запрос:



// ╔════════════════════════════════════════════════════════════╗
// ║  ЧАСТЬ 2: СОЗДАНИЕ (insert)                               ║
// ╚════════════════════════════════════════════════════════════╝

// --- 2.1. Вставка одного документа ---
db.equipment.insertOne({
  _id: "EQ099",
  type: "ПДМ",
  model: "ST18",
  manufacturer: "Atlas Copco",
  status: "working",
  mine: { _id: "M001", name: "Северная" },
  engine_hours: 0
});

// Проверка
db.equipment.findOne({ _id: "EQ099" });

// --- 2.2. Попытка вставки невалидного документа ---
// Этот INSERT должен завершиться ошибкой Schema Validation!
try {
  db.equipment.insertOne({
    _id: "INVALID",           // нарушает паттерн ^EQ\d{3}$
    type: "Бульдозер",        // нет в enum
    status: "ok"              // нет в enum
  });
} catch (e) {
  print("Ожидаемая ошибка: " + e.message);
}


// ╔════════════════════════════════════════════════════════════╗
// ║  ЧАСТЬ 3: ОБНОВЛЕНИЕ (update)                             ║
// ╚════════════════════════════════════════════════════════════╝

// --- 3.1. Обновление одного поля ($set) ---
// Перевести EQ003 из maintenance обратно в working
db.equipment.updateOne(
  { _id: "EQ003" },
  { $set: { status: "working" } }
);

// Проверка
db.equipment.findOne({ _id: "EQ003" }, { _id: 1, status: 1 });

// --- 3.2. Атомарный инкремент ($inc) ---
// Увеличить наработку EQ001 на 8.5 моточасов
db.equipment.updateOne(
  { _id: "EQ001" },
  { $inc: { engine_hours: 8.5 } }
);

// Проверка
db.equipment.findOne({ _id: "EQ001" }, { _id: 1, engine_hours: 1 });

// --- 3.3. Добавление элемента в массив ($push) ---
// Добавить запись ТО в историю обслуживания
db.equipment.updateOne(
  { _id: "EQ001" },
  { $push: {
      "maintenance.history": {
        date: "2025-02-15",
        type: "ТО-3",
        cost: 65000,
        description: "Замена гидронасоса"
      }
  }}
);

// Проверка — посмотрим историю ТО
db.equipment.findOne(
  { _id: "EQ001" },
  { "maintenance.history": 1 }
);

// --- 3.4. Обновление нескольких полей одновременно ---
db.equipment.updateOne(
  { _id: "EQ001" },
  {
    $set: {
      "maintenance.last_service": "2025-02-15",
      "maintenance.next_service": "2025-05-15"
    }
  }
);

// --- 3.5. Обновление нескольких документов (updateMany) ---
// Добавить поле firmware_version всем самосвалам
db.equipment.updateMany(
  { type: "Самосвал" },
  { $set: { firmware_version: "3.2.1" } }
);

// Проверка
db.equipment.find(
  { type: "Самосвал" },
  { _id: 1, firmware_version: 1 }
);

// --- 3.6. Удаление поля ($unset) ---
db.equipment.updateMany(
  { type: "Самосвал" },
  { $unset: { firmware_version: "" } }
);


// ╔════════════════════════════════════════════════════════════╗
// ║  ЗАДАНИЕ 2 (самостоятельно):                              ║
// ║  Обновите координаты оборудования EQ005:                  ║
// ║  latitude=56.84, longitude=60.61, level=-200              ║
// ╚════════════════════════════════════════════════════════════╝

// Ваш запрос:



// ╔════════════════════════════════════════════════════════════╗
// ║  ЧАСТЬ 4: УДАЛЕНИЕ (delete)                               ║
// ╚════════════════════════════════════════════════════════════╝

// --- 4.1. Удаление одного документа ---
db.equipment.deleteOne({ _id: "EQ099" });

// Проверка — документ удалён
db.equipment.findOne({ _id: "EQ099" });

// --- 4.2. Подсчёт оставшихся ---
print("Оборудование: " + db.equipment.countDocuments() + " документов");


// ╔════════════════════════════════════════════════════════════╗
// ║  ЧАСТЬ 5: Запросы к коллекции incidents                   ║
// ╚════════════════════════════════════════════════════════════╝

// --- 5.1. Все критические инциденты ---
db.incidents.find({ severity: "critical" });

// --- 5.2. Инциденты по шахте "Северная" ---
db.incidents.find({ mine_name: "Северная" });

// --- 5.3. Инциденты с конкретным оборудованием ---
db.incidents.find({ equipment_id: "EQ005" });

// --- 5.4. Инциденты за период ---
db.incidents.find({
  incident_date: {
    $gte: "2025-02-01T00:00:00Z",
    $lt: "2025-03-01T00:00:00Z"
  }
});

// --- 5.5. Нерешённые инциденты ---
db.incidents.find({
  status: { $in: ["open", "in_progress", "monitoring"] }
});


// ╔════════════════════════════════════════════════════════════╗
// ║  ЗАДАНИЕ 3 (самостоятельно):                              ║
// ║  1. Найдите все инциденты типа "sensor_alert" с           ║
// ║     severity "warning" или "critical"                     ║
// ║  2. Обновите статус INC005 на "resolved" и добавьте       ║
// ║     resolved_date текущей датой                           ║
// ╚════════════════════════════════════════════════════════════╝

// Ваш запрос:



// ╔════════════════════════════════════════════════════════════╗
// ║  ЧАСТЬ 6: Запросы к коллекции mines                       ║
// ╚════════════════════════════════════════════════════════════╝

// --- 6.1. Все шахты ---
db.mines.find({}, { _id: 1, name: 1, depth_m: 1, status: 1 });

// --- 6.2. Шахта с самым глубоким горизонтом ---
db.mines.find(
  {},
  { name: 1, depth_m: 1, "horizons.level": 1 }
).sort({ depth_m: -1 }).limit(1);

// --- 6.3. Активные горизонты конкретной шахты ---
// Используем $elemMatch для фильтрации элементов массива
db.mines.find(
  { _id: "M001" },
  {
    name: 1,
    horizons: {
      $elemMatch: { status: "active" }
    }
  }
);


print("\n✓ Скрипт 03 выполнен. Все CRUD-операции продемонстрированы.");
